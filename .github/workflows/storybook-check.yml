name: Storybook Story Check

on:
  pull_request:
    branches: [main, master]
    paths:
      - 'src/**/*.tsx'
      - 'src/**/*.ts'
      - '!src/**/*.stories.ts'
      - '!src/**/*.stories.tsx'

jobs:
  check-stories:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            src/**/*.tsx
            src/**/*.ts
          files_ignore: |
            src/**/*.stories.ts
            src/**/*.stories.tsx
            src/**/*.test.ts
            src/**/*.test.tsx
            src/**/*.spec.ts
            src/**/*.spec.tsx
            src/**/index.ts
            src/**/index.tsx
            src/main.tsx
            src/App.tsx
            src/vite-env.d.ts

      - name: Check for missing stories
        id: check-stories
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Checking for missing story files..."

          MISSING_STORIES=""
          CHANGED_COMPONENTS="${{ steps.changed-files.outputs.all_changed_files }}"

          for file in $CHANGED_COMPONENTS; do
            # Skip non-component files (utilities, hooks, types, etc.)
            filename=$(basename "$file")

            # Skip files that start with lowercase (typically utilities/hooks)
            first_char="${filename:0:1}"
            if [[ "$first_char" =~ [a-z] ]]; then
              echo "Skipping non-component file: $file"
              continue
            fi

            # Skip files in specific directories
            if [[ "$file" == *"/hooks/"* ]] || [[ "$file" == *"/utils/"* ]] || [[ "$file" == *"/types/"* ]] || [[ "$file" == *"/contexts/"* ]] || [[ "$file" == *"/services/"* ]]; then
              echo "Skipping utility file: $file"
              continue
            fi

            # Get the directory and base name without extension
            dir=$(dirname "$file")
            base=$(basename "$file" .tsx)
            base=$(basename "$base" .ts)

            # Check for story file in same directory
            story_file_ts="$dir/$base.stories.ts"
            story_file_tsx="$dir/$base.stories.tsx"

            if [[ ! -f "$story_file_ts" ]] && [[ ! -f "$story_file_tsx" ]]; then
              echo "Missing story for: $file"
              MISSING_STORIES="$MISSING_STORIES- $file (Expected: $base.stories.ts or $base.stories.tsx)\n"
            else
              echo "Story exists for: $file"
            fi
          done

          if [[ -n "$MISSING_STORIES" ]]; then
            echo "missing_stories=true" >> $GITHUB_OUTPUT
            # Use heredoc for multiline output
            {
              echo "missing_list<<EOF"
              echo -e "$MISSING_STORIES"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "missing_stories=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: steps.check-stories.outputs.missing_stories == 'true'
        uses: actions/github-script@v7
        env:
          MISSING_LIST: ${{ steps.check-stories.outputs.missing_list }}
        with:
          script: |
            const missingList = process.env.MISSING_LIST;

            const body = [
              '## üìö Storybook Story Check',
              '',
              '### ‚ö†Ô∏è Missing Story Files Detected',
              '',
              'The following component files were modified but do not have corresponding Story files:',
              '',
              missingList,
              '',
              '### Why This Matters',
              '- Story files help document component usage and variations',
              '- They enable visual testing and review',
              '- They serve as living documentation for the design system',
              '',
              '### How to Fix',
              '1. Create a `.stories.ts` or `.stories.tsx` file next to each component',
              '2. Document the component\'s props and variations',
              '3. Add examples showing different states',
              '',
              '<details>',
              '<summary>üìñ Story File Template</summary>',
              '',
              '```typescript',
              'import type { Meta, StoryObj } from \'@storybook/react\';',
              'import { YourComponent } from \'./YourComponent\';',
              '',
              'const meta: Meta<typeof YourComponent> = {',
              '  title: \'Components/YourComponent\',',
              '  component: YourComponent,',
              '  parameters: {',
              '    layout: \'centered\',',
              '  },',
              '  tags: [\'autodocs\'],',
              '};',
              '',
              'export default meta;',
              'type Story = StoryObj<typeof meta>;',
              '',
              'export const Default: Story = {',
              '  args: {',
              '    // your props here',
              '  },',
              '};',
              '```',
              '</details>',
              '',
              '---',
              '*This check helps maintain component documentation quality.*'
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Storybook Story Check')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Remove outdated comment
        if: steps.check-stories.outputs.missing_stories == 'false' || steps.changed-files.outputs.any_changed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Storybook Story Check')
            );

            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
              });
            }

      - name: Summary
        run: |
          echo "## Storybook Check Summary" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check-stories.outputs.missing_stories }}" == "true" ]]; then
            echo "‚ö†Ô∏è **Missing Stories Detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.check-stories.outputs.missing_list }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **All modified components have Story files**" >> $GITHUB_STEP_SUMMARY
          fi
